[comment encoding = UTF-8 /]
[module generateDeployment('http://www.typhon.org/dsls/xtext/TyphonDL', 'http://www.eclipse.org/emf/2002/Ecore')]

[import de::atb::typhondl::acceleo::common::utilityGenerator/]

[template public generateDeployment(aDeploymentModel : DeploymentModel)? (aDeploymentModel.isDocker()) post (trim())]

[for (aCluster : Cluster | aDeploymentModel.getAllClusters())]
[for (aApplication : Application | aCluster.getAllApplications())]
	
[file (aApplication.name + '/docker-compose.yml', false, 'UTF-8')]
version: '3.7'

[if (aCluster.networks <> null)]
[for (aNetwork : Cluster_Network | aCluster.networks)]
[aNetwork.print()/]
[/for]
[/if]
services:
[for (aContainer : Container | aApplication.getAllContainers())]
  [aContainer.name/]:
[if (aContainer.deploys <> null)]
    [aContainer.deploys.reference.printFeature()/]
[/if]
[if (aContainer.depends_on <> null)]
[for (aDependency : Dependency | aContainer.depends_on)]
    depends_on: 
      - [aDependency.reference.name/]
[/for]
[/if]
[if (aContainer.networks <> null)]
    [aContainer.networks.print()/]
[/if]    
[if (aContainer.properties <> null)]
[for (aProperty : Property | aContainer.properties)]
    [aProperty.printProperties()/]
[/for]
[/if]
[/for]
[/file]
[/for]
[/for]
[/template]

[template public print(aNetwork : Cluster_Network) post (trim())]
networks:
  [aNetwork.name/]: 
[for (key_Values : Key_Values | aNetwork.key_values)]
    [key_Values.printProperties()/]
[/for]
[/template]

[template public print(networks : Container_Network) post (trim())]
networks:
[for (reference : Cluster_Network | networks.references)]
  - [reference.name/]
[/for]
[/template]

[template public printProperties(aProperty : Property) post (trim()) ]
	something went wrong with Rule Property
[/template]

[template public printProperties(aProperty : Key_Values)  post (trim())]
[aProperty.name/]: [aProperty.value/][if (aProperty.values <> null)][for (aVal : String | aProperty.values)], [aVal/][/for]
[/if]
[/template]

[template public printProperties(aProperty : Key_KeyValueList)  post (trim())]
[aProperty.name/]:
[for (aVar : Key_Values | aProperty.key_Values)]
  [aVar.printProperties()/]
[/for][/template]

[template public printProperties(aProperty : Key_ValueArray)  post (trim())]
[aProperty.name/]:
[for (aValue : EString | aProperty.values)]
  - [aValue/]
[/for]
[/template]

[template public printFeature(software : Software)  post (trim())]
	something went wrong with Rule Software
[/template]

[template public printFeature(software : NonDB)  post (trim())]
image: [software.image.value/]
[if (software.parameters <> null)]
[for (aProperty : Property | software.parameters)]
[aProperty.printProperties()/]
[/for]
[/if]
[/template]

[template public printFeature(db : DB)  post (trim())]
image: [db.image.value/]
[if (db.parameters <> null)]
[for (aProperty : Property | db.parameters)]
[aProperty.printProperties()/]
[/for]
[/if]
[/template]


