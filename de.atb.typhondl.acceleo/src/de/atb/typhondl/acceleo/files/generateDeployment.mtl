[comment encoding = UTF-8 /]
[module generateDeployment('http://www.typhon.org/dsls/xtext/TyphonDL', 'http://www.eclipse.org/emf/2002/Ecore')]

[import de::atb::typhondl::acceleo::common::utilityGenerator/]

[template public generateDeployment(aDeploymentModel : DeploymentModel)]

[for (aCluster : Cluster | aDeploymentModel.getAllClusters())]
[for (aApplication : Application | aCluster.getAllApplications())]
	
[file (aApplication.name + '/docker-compose.yml', false, 'UTF-8')]
version: '3.7'

services:
[for (aContainer : Container | aApplication.getAllContainers())]
  [aContainer.name/]:
[for (aReference : Reference | aContainer.deploys)]
    [aReference.reference.printFeature()/]
[/for]
[for (aDependency : Dependency | aContainer.depends_on)]
    depends_on: 
      - [aDependency.reference.name/]
[/for]
[for (aProperty : Property | aContainer.properties)]
    [aProperty.printProperties()/]
[/for]
[/for]
[/file]
[/for]
[/for]
[/template]

[template public printProperties(aProperty : Property) ]
	test1
[/template]

[template public printProperties(aProperty : Key_Value) ]
[if (aProperty.name.equalsIgnoreCase('ports'))] [aProperty.name/]: 
  - [aProperty.value/] [elseif (aProperty.name.equalsIgnoreCase('volumes'))] [aProperty.name/]:
  - [aProperty.value/] [else] 
[aProperty.name/]: [aProperty.value/]
[/if]

[/template]

[template public printProperties(aProperty : Key_KeyValueList) ]
[aProperty.name/]:
[for (aVar : Key_Value | aProperty.key_Values)]
  [aVar.printProperties()/]
[/for][/template]

[template public printProperties(aProperty : Key_ValueArray) ]
[aProperty.name/]: [ '[' /]
  '[aProperty.value/]'[for (aValue : EString | aProperty.values)],
  '[aValue/]'
[/for]
[ ']' /]
[/template]

[template public printFeature(software : Software) ]
	something went wrong with Rule Software
[/template]

[template public printFeature(software : NonDB) ]
image: [software.image.value/]
[for (aProperty : Property | software.parameters)]
[aProperty.printProperties()/]
[/for]
[/template]

[template public printFeature(db : DB) ]
image: [db.image.value/]
[for (aProperty : Property | db.parameters)]
[aProperty.printProperties()/]
[/for]
[/template]


